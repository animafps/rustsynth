name: build
on:
  push:
  pull_request:

jobs:
  build-test-lint-linux:
    name: Linux - build, test and lint
    runs-on: ubuntu-latest
    env: 
      LD_LIBRARY_PATH: /usr/local/lib
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Install VapourSynth
        uses: animafps/install-vapoursynth-action@master
        with:
          version: 61
          cache: true
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      - name: Build
        run: |
          cargo build
      - name: Test
        run: |
          cargo test --workspace --lib --bins --tests --benches 
      - name: Lint
        run: |
          cargo clippy
      - name: Check format
        run: |
          cargo fmt -- --check
  build-test-lint-macos:
    name: macOS - build, test and lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Install VapourSynth
        run: |
          brew install vapoursynth
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      - name: Build
        run: |
          cargo build
      - name: Test
        run: |
          cargo test --workspace --lib --bins --tests --benches 
      - name: Lint
        run: |
          cargo clippy
      - name: Check format
        run: |
          cargo fmt -- --check
  ## build-test-lint-windows:
  ##  name: Windows - build, test and lint
  ##  runs-on: windows-latest
  ##  steps:
  ##    - uses: actions/checkout@v2
  ##    - name: Set up Rust
  ##      uses: actions-rs/toolchain@v1
  ##     with:
  ##       toolchain: stable
  ##        override: true
  ##       components: rustfmt, clippy
  ##    - name: Build
  ##      run: |
  ##        cargo build
  ##    - name: Test
  ##      run: |
  ##        cargo test
  ##    - name: Lint
  ##      run: |
  ##        cargo clippy -- -D warnings
  ##    - name: Check format
  ##      run: |
  ##        cargo fmt -- --check